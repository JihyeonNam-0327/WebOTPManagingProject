--입실 시간, 퇴실 시간이 모두 null 일 경우는 stauts=4(결석)
CREATE EVENT IF NOT EXISTS evt1_makestatus
ON SCHEDULE EVERY '1' DAY
STARTS '2018-03-30 23:59:05'
COMMENT 'Make status at 23:59 daily'
DO
UPDATE KOPOCTC.managingDB SET status = 4 WHERE time_in is null AND time_out is null;

--입실 시간이 없고 퇴실 시간만 찍힌 경우는 status=2(지각)
CREATE EVENT IF NOT EXISTS evt2_makestatus
ON SCHEDULE EVERY '1' DAY
STARTS '2018-03-30 23:59:10'
COMMENT 'Make status at 23:59 daily'
DO
UPDATE KOPOCTC.managingDB SET status = 2 WHERE time_in is not null AND time_out is null;

--입실 시간은 있고 퇴실 시간만 찍힌 경우는 status=1(조퇴)
CREATE EVENT IF NOT EXISTS evt3_makestatus
ON SCHEDULE EVERY '1' DAY
STARTS '2018-03-30 23:59:15'
COMMENT 'Make status at 23:59 daily'
DO
UPDATE KOPOCTC.managingDB SET status = 1 WHERE time_in is null AND time_out is not null;

-입실 시간과 퇴실 시간 모두 없으면 status=5(결석)
CREATE EVENT IF NOT EXISTS evt4_makestatus
ON SCHEDULE EVERY '1' DAY
STARTS '2018-03-30 23:59:20'
COMMENT 'Make status at 23:59 daily'
DO
UPDATE KOPOCTC.managingDB SET status = 5 WHERE time_in is not null AND time_out is not null;

--managingDB의 내용을 attendanceDB로 적재
CREATE EVENT IF NOT EXISTS evt_save
ON SCHEDULE EVERY '1' DAY
STARTS '2018-03-30 23:59:25'
COMMENT 'Sate status at 23:59 daily'
DO
INSERT INTO KOPOCTC.attendanceDB(_id,time_in,time_out,status,date) SELECT _id,time_in,time_out,status,date FROM KOPOCTC.managingDB;

--managingDB의 내용을 모두 삭제
CREATE EVENT IF NOT EXISTS evt_delete
ON SCHEDULE EVERY '1' DAY
STARTS '2018-03-30 23:59:50'
COMMENT 'Delete managingDB at 23:58 daily'
DO
DELETE FROM KOPOCTC.managingDB;

--다음 날 managingDB의 내용을 새로 생성
CREATE EVENT IF NOT EXISTS evt_insert
ON SCHEDULE EVERY '1' DAY
STARTS '2018-03-31 00:00:01'
COMMENT 'Insert into managingDB at 23:59 daily'
DO
INSERT INTO KOPOCTC.managingDB(_id) SELECT _id FROM KOPOCTC.otpDB;

--생성한 otp를 3분 뒤 삭제하는 1회성 이벤트 스케쥴러 생성
CREATE EVENT IF NOT EXISTS evt_otp_delete
ON SCHEDULE
AT CURRENT_TIMESTAMP + INTERVAL 3 MINUTE
COMMENT 'Insert into managingDB at 23:59 daily'
DO
DELETE otp FROM KOPOCTC.otpDB WHERE _id=?;